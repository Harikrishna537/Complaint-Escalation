{% extends "base.html" %}

{% block title %}Complaint Details - Complaint Portal{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
    <!-- Header with Back Button -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <a href="{% if session.user_type == 'admin' %}{{ url_for('admin_dashboard') }}{% else %}{{ url_for('user_dashboard') }}{% endif %}" 
                   class="inline-flex items-center text-primary-600 hover:text-primary-800 mb-4 transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>
                    Back to Dashboard
                </a>
                <h1 class="text-3xl font-bold text-gray-900">
                    <i class="fas fa-file-alt text-primary-600 mr-3"></i>
                    Complaint Details
                </h1>
            </div>
            
            {% if session.user_type == 'admin' %}
                <div class="flex items-center space-x-4">
                    <form method="POST" action="{{ url_for('update_status') }}" class="flex items-center space-x-2">
                        <input type="hidden" name="complaint_id" value="{{ complaint._id }}">
                        <label class="text-sm font-medium text-gray-700">Update Status:</label>
                        <select name="status" onchange="this.form.submit()"
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent">
                            {% for status in complaint_statuses %}
                                <option value="{{ status }}" {% if status == complaint.status %}selected{% endif %}>
                                    {{ status }}
                                </option>
                            {% endfor %}
                        </select>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Complaint Details -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Complaint Info Card -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-primary-500 to-primary-600">
                    <h2 class="text-xl font-semibold text-white">{{ complaint.title }}</h2>
                </div>
                
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="flex items-center">
                            <i class="fas fa-tag text-primary-500 mr-2"></i>
                            <div>
                                <p class="text-sm text-gray-500">Category</p>
                                <p class="font-medium">{{ complaint.type }}</p>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <i class="fas fa-info-circle text-primary-500 mr-2"></i>
                            <div>
                                <p class="text-sm text-gray-500">Status</p>
                                <span class="px-3 py-1 text-sm font-semibold rounded-full border
                                    status-{{ complaint.status.lower().replace(' ', '-') }}">
                                    {{ complaint.status }}
                                </span>
                            </div>
                        </div>
                        
                        <div class="flex items-center">
                            <i class="fas fa-calendar text-primary-500 mr-2"></i>
                            <div>
                                <p class="text-sm text-gray-500">Submitted</p>
                                <p class="font-medium">{{ complaint.created_at.strftime('%B %d, %Y') }}</p>
                                <p class="text-sm text-gray-500">{{ complaint.created_at.strftime('%I:%M %p') }}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-3">Description</h3>
                        <div class="bg-gray-50 rounded-lg p-4">
                            <p class="text-gray-700 leading-relaxed whitespace-pre-wrap">{{ complaint.description }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-comments text-primary-600 mr-2"></i>
                        Comments ({{ complaint.comments|length }})
                    </h3>
                </div>
                
                <div class="p-6">
                    <!-- Add Comment Form -->
                    <form method="POST" action="{{ url_for('add_comment') }}" class="mb-6">
                        <input type="hidden" name="complaint_id" value="{{ complaint._id }}">
                        <div class="flex space-x-4">
                            <div class="flex-shrink-0">
                                <div class="w-10 h-10 bg-primary-500 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user text-white text-sm"></i>
                                </div>
                            </div>
                            <div class="flex-1">
                                <textarea name="comment" required
                                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent resize-none"
                                          rows="3" placeholder="Add a comment..."></textarea>
                                <div class="mt-3 flex justify-end">
                                    <button type="submit"
                                            class="inline-flex items-center px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transform hover:scale-105 transition-all duration-200">
                                        <i class="fas fa-paper-plane mr-2"></i>
                                        Post Comment
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>

                    <!-- Comments List -->
                    {% if complaint.comments %}
                        <div class="space-y-6">
                            {% for comment in complaint.comments|reverse %}
                                <div class="flex space-x-4">
                                    <div class="flex-shrink-0">
                                        <div class="w-10 h-10 
                                            {% if comment.user_type == 'admin' %}bg-red-500{% else %}bg-primary-500{% endif %} 
                                            rounded-full flex items-center justify-center">
                                            <i class="fas 
                                                {% if comment.user_type == 'admin' %}fa-shield-alt{% else %}fa-user{% endif %} 
                                                text-white text-sm"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-gray-50 rounded-lg p-4">
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center space-x-2">
                                                    <span class="font-medium text-gray-900">{{ comment.username }}</span>
                                                    <span class="px-2 py-1 text-xs font-semibold rounded-full
                                                        {% if comment.user_type == 'admin' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                                                        {{ comment.user_type.title() }}
                                                    </span>
                                                </div>
                                                <span class="text-sm text-gray-500">
                                                    {{ comment.created_at.strftime('%B %d, %Y at %I:%M %p') }}
                                                </span>
                                            </div>
                                            <p class="text-gray-700 whitespace-pre-wrap">{{ comment.comment }}</p>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8">
                            <i class="fas fa-comment-slash text-4xl text-gray-300 mb-3"></i>
                            <p class="text-gray-500">No comments yet. Be the first to comment!</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="lg:col-span-1">
            <div class="space-y-6 sticky top-6">
                <!-- User Info Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-user text-primary-600 mr-2"></i>
                        Submitted By
                    </h3>
                    
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-12 h-12 bg-primary-500 rounded-full flex items-center justify-center">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">{{ user.username }}</p>
                            <p class="text-sm text-gray-500">{{ user.email }}</p>
                        </div>
                    </div>
                    
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-500">Member since:</span>
                            <span class="font-medium">{{ user.created_at.strftime('%B %Y') }}</span>
                        </div>
                    </div>
                </div>

                <!-- Timeline Card -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-history text-primary-600 mr-2"></i>
                        Timeline
                    </h3>
                    
                    <div class="space-y-4">
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-plus text-white text-xs"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Complaint Submitted</p>
                                <p class="text-xs text-gray-500">{{ complaint.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                            </div>
                        </div>
                        
                        {% if complaint.updated_at != complaint.created_at %}
                            <div class="flex items-start space-x-3">
                                <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-sync text-white text-xs"></i>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">Last Updated</p>
                                    <p class="text-xs text-gray-500">{{ complaint.updated_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                                </div>
                            </div>
                        {% endif %}
                        
                        <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 
                                {% if complaint.status == 'Resolved' %}bg-green-500
                                {% elif complaint.status == 'In Progress' %}bg-blue-500
                                {% elif complaint.status == 'Under Review' %}bg-purple-500
                                {% else %}bg-yellow-500{% endif %} 
                                rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas 
                                    {% if complaint.status == 'Resolved' %}fa-check
                                    {% elif complaint.status == 'In Progress' %}fa-spinner
                                    {% elif complaint.status == 'Under Review' %}fa-search
                                    {% else %}fa-clock{% endif %} 
                                    text-white text-xs"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-900">Current Status</p>
                                <p class="text-xs font-semibold 
                                    {% if complaint.status == 'Resolved' %}text-green-600
                                    {% elif complaint.status == 'In Progress' %}text-blue-600
                                    {% elif complaint.status == 'Under Review' %}text-purple-600
                                    {% else %}text-yellow-600{% endif %}">
                                    {{ complaint.status }}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}